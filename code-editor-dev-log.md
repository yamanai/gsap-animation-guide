# GsapEditor 组件开发日志

## 背景

本文档记录了在 GSAP 学习项目中，代码编辑器组件的开发过程、问题解决和功能升级。该组件用于提供交互式代码演示，让用户可以编辑和运行 GSAP 动画代码。

## 初始版本问题

初始版本存在以下问题：

1. **选择器不匹配**：代码使用了 `.demo-element` 选择器，而实际 DOM 元素使用的是 `.animation-target`
2. **GSAP 加载问题**：没有正确处理 GSAP 库的异步加载
3. **预览区域太小**：预览区域尺寸不足，影响动画效果展示
4. **缺少语法高亮**：代码没有语法高亮，降低了可读性
5. **主题不适配**：编辑器主题无法跟随网站主题变化

## 问题修复记录

### 第一阶段：基础功能修复

1. 修正选择器问题
   - 将 `.demo-element` 改为 `.animation-target`
   - 确保代码示例与实际 DOM 元素匹配

2. 改进 GSAP 加载处理
   - 添加 `window.gsapLoaded` 状态跟踪
   - 增加加载检测和错误处理
   - 修复了动画不执行的问题

### 第二阶段：编辑器升级

1. 集成 CodeMirror 6
   - 安装相关依赖：
     ```
     @codemirror/state
     @codemirror/view
     @codemirror/lang-javascript
     @codemirror/commands
     @codemirror/theme-one-dark
     @lezer/highlight
     ```
   - 实现代码语法高亮
   - 添加行号显示和编辑增强功能

2. 增大预览区域
   - 移动端：300px → 400px
   - 桌面端：300px → 400px

3. 改进 UI 设计
   - 优化布局和间距
   - 增强按钮视觉反馈

### 第三阶段：主题适配

1. 实现亮色/暗色主题
   - 创建两套完整配色方案：
     - 暗色主题基于 OneDark
     - 亮色主题类似 VS Code 默认主题

2. 主题自动跟随
   - 集成 VitePress 的 `useData()` 钩子获取 `isDark` 状态
   - 监听主题变化，动态重建编辑器
   - 所有 UI 元素使用 CSS 变量，自动适配主题

3. 降级处理优化
   - 确保 CodeMirror 加载失败时有合适的后备方案
   - 文本框也能根据主题切换样式

### 第四阶段：组件统一与优化

1. 组件重命名与统一
   - 将 `CodeEditor` 组件重命名为 `GsapEditor`
   - 统一所有文档中的编辑器引用
   - 保持API兼容，只更改组件名称
   
2. 移除交互过渡动画
   - 去除鼠标悬停时编辑器上浮的动画效果
   - 保留阴影变化，保持视觉反馈
   - 解决了用户体验的稳定性问题

3. 代码整理与优化
   - 统一组件接口和属性
   - 清理冗余代码
   - 提高代码可维护性

### 第五阶段：GSAP加载优化与本地化

1. 解决CDN加载问题
   - 修复"GSAP加载失败，已达到最大重试次数"错误
   - 将CDN源从 unpkg.com 替换为 cdnjs.cloudflare.com
   - 增加最大重试次数从3次到5次
   - 延长重试间隔时间，使用递增延迟策略

2. GSAP本地化加载方案
   - 实现基于 npm 包的本地加载机制
   - 使用 `baseUrl` 和 `getGsapPath` 函数构建本地文件路径
   - 区分开发环境和生产环境的路径处理

3. 插件加载优化
   - 区分必要插件和可选插件
   - 采用分级加载策略：核心库 → 必要插件 → 可选插件
   - 确保即使部分插件加载失败，核心功能仍能正常运行

4. 构建流程改进
   - 添加 `build-plugins.js` 脚本自动复制GSAP文件
   - 配置 `vite.config.js` 处理静态资源
   - 更新 `package.json` 添加构建钩子

## 当前特性

1. **语法高亮**：JavaScript 专业语法高亮
2. **主题自适应**：自动跟随网站主题切换
3. **行号显示**：提升代码可读性
4. **错误处理**：友好的错误提示
5. **响应式设计**：适配不同屏幕尺寸
   - 桌面端：左右布局（预览40%，编辑器60%）
   - 移动端：上下布局
6. **代码沙箱**：安全执行用户代码
7. **稳定交互**：移除上浮动画，提供稳定的交互体验
8. **离线可用**：支持本地GSAP文件加载，摆脱网络依赖
9. **智能加载**：自动识别环境，选择最优加载方式

## 使用方式

在 Markdown 文件中使用：

```md
<GsapEditor 
  title="GSAP基础动画示例"
  :initialJs="`// 尝试修改这段代码
gsap.to('.animation-target', { 
  duration: 1, 
  x: 100, 
  rotation: 360, 
  backgroundColor: '#42b883' 
});`"
/>
```

## 未来计划

1. **多目标元素**：支持多个动画目标元素
2. **时间轴控制**：添加播放/暂停/重置和进度条
3. **代码片段库**：预设代码示例
4. **更多语言支持**：除了 JavaScript 外，支持 TypeScript、HTML 等
5. **代码补全**：提供 GSAP API 代码提示
6. **全屏预览模式**：支持切换到全屏展示复杂动画

## 技术债务

1. **包版本兼容性**：部分 CodeMirror 包存在版本兼容问题
2. **主题切换闪烁**：主题切换时存在短暂白屏

## 开发环境

- **操作系统**：Windows 10
- **Node.js**：v16.x
- **包管理器**：npm
- **框架**：VitePress 1.0.0-alpha.28
- **CodeMirror**：v6.x
- **GSAP**：v3.13.0

## 相关文件

- 主组件：`docs/.vitepress/theme/components/GsapEditor.vue`
- 主题配置：`docs/.vitepress/theme/index.js`
- 使用示例：`docs/basics/index.md`
- 构建脚本：`docs/.vitepress/build-plugins.js`
- Vite配置：`vite.config.js`

## 版本历史

### v1.5.0 (当前版本)
- 实现GSAP本地加载，摆脱CDN依赖
- 添加构建流程自动复制GSAP文件
- 优化插件加载策略，区分必要和可选插件
- 提升错误处理能力和用户体验
- 添加智能环境检测，适应不同运行环境

### v1.4.0
- 组件重命名：CodeEditor → GsapEditor
- 移除鼠标悬停时的上浮动画效果
- 统一所有文档中的组件使用
- 优化组件接口和代码结构

### v1.3.0
- 添加主题自适应功能
- 支持亮色/暗色主题自动切换
- 修复版本兼容性问题
- 优化 UI 设计

### v1.2.0
- 集成 CodeMirror 6
- 实现代码语法高亮
- 增大预览区域尺寸
- 添加行号显示

### v1.1.0
- 修复 GSAP 加载问题
- 添加错误处理和提示
- 改进代码执行沙箱

### v1.0.0
- 初始版本
- 基本代码编辑功能
- 动画预览和执行

---

*最后更新：2023年8月15日* 